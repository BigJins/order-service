# Order Service 도메인 모델 (v1 · 취업용)

> Aggregate Root = **Order**  
> 통화 = **KRW(원화) only**  
> 목표: “주문 생성/확정/취소”의 **상태 전이**와 **금액/라인 불변식**을 도메인에서 강제한다.

---

## 1. 도메인 경계

- **Order Service**는 주문의 생명주기(생성 → 확정 → 취소)를 책임진다.
- 외부 시스템(회원/상품/결제/배송)은 별도 서비스로 가정한다.
- Order Service는 외부 식별자를 **참조만** 한다.
    - buyerId: 회원 서비스 식별자
    - productId: 상품 서비스 식별자

---

## 2. 핵심 개념

### 2.1 Aggregate Root
- **Order (Entity / Aggregate Root)**  
  주문의 상태 전이와 불변식(invariant)을 보장하는 최상위 도메인 객체.

### 2.2 Value Objects
- **Money (VO)**  
  원화 금액 표현. 불변이며 값 기반 동등성.
- **OrderLine (VO)**  
  주문 항목. 상품 식별자 및 주문 시점 스냅샷(상품명/단가)과 수량을 포함.
- **ShippingInfo (VO)**  
  수령인 정보/주소/요청사항 등 배송지 정보.

---

## 3. 상태 모델

### 3.1 OrderStatus
- `CREATED` : 주문 생성됨(결제/확정 전)
- `CONFIRMED` : 주문 확정됨(결제 승인 완료로 간주)
- `CANCELLED` : 주문 취소됨(종료 상태)

### 3.2 상태 전이(State Transitions)

허용:
- `CREATED` → `CONFIRMED` (confirm)
- `CREATED` → `CANCELLED` (cancel)

금지:
- `CONFIRMED` → `CREATED`
- `CANCELLED` → Any
- `CONFIRMED` → `CANCELLED` (v1에서는 금지, v2에서 “출고 전 취소” 등으로 확장 가능)

---

## 4. 엔티티/VO 정의

## 4.1 Order (Aggregate Root / Entity)

### 책임(Responsibility)
- 주문 생성 시 불변식 검증
- 주문 확정/취소 시 상태 전이 규칙 검증
- 총액(totalAmount) 계산 및 일관성 유지
- 주문 변경 가능 범위를 제어(확정 후 변경 금지 등)

### 속성(Attributes)
- `id` : Long (DB 식별자)
- `orderNo` : String (사람이 보는 주문번호, 유니크)
- `buyerId` : Long (회원 식별자)
- `status` : OrderStatus
- `orderLines` : List<OrderLine> (VO, Order에 종속)
- `shippingInfo` : ShippingInfo (VO)
- `totalAmount` : Money (VO)
- `createdAt` : LocalDateTime
- `confirmedAt` : LocalDateTime? (nullable)
- `cancelledAt` : LocalDateTime? (nullable)
- (선택) `cancelReason` : String? (v1 선택, v2 권장)

### 불변식(Invariants)
- 주문라인은 **1개 이상**이어야 한다.
- 각 라인의 수량(quantity)은 **1 이상**이어야 한다.
- `totalAmount`는 항상 `Σ(orderLine.lineAmount)`와 일치해야 한다.
- `orderNo`는 비어있지 않고 유니크해야 한다.
- `buyerId`는 반드시 존재해야 한다(Null 불가).

> 참고: Null/형식/길이 같은 “입력값 검증”은 Application(Service/DTO)에서도 하고,  
> 도메인에서는 “의미 규칙”을 최종적으로 보장한다.

### 도메인 행위(Behaviors)
- `create(...)` : 주문 생성(정적 팩토리 권장)
    - status = CREATED
    - totalAmount 계산
    - createdAt set
- `confirm()` : 주문 확정
    - status가 CREATED일 때만 가능
    - status = CONFIRMED
    - confirmedAt set
- `cancel(reason?)` : 주문 취소
    - status가 CREATED일 때만 가능
    - status = CANCELLED
    - cancelledAt set
    - (선택) cancelReason set

---

## 4.2 Money (Value Object)

### 정의
- 원화(KRW)만 다룬다.
- 금액은 원 단위 정수로 표현한다.

### 속성
- `amount` : long (won)

### 규칙
- amount는 **0 이상**이어야 한다.
- 불변 객체이며, 연산은 새 Money를 반환한다.

### 도메인 연산(예시)
- `plus(Money other)` : 금액 합산
- `multiply(int quantity)` : 수량 곱(수량 음수 금지)

---

## 4.3 OrderLine (Value Object)

### 정의
- 주문 항목. “주문 시점”의 상품 정보를 스냅샷으로 보관한다.

### 속성
- `productId` : Long
- `productNameSnapshot` : String (길이 제한 권장: 200)
- `unitPrice` : Money
- `quantity` : int

### 규칙
- productId는 null 불가
- productNameSnapshot은 공백/빈 문자열 금지, 길이 제한 준수
- unitPrice는 null 불가
- quantity는 **1 이상**
- lineAmount = unitPrice * quantity

### 행위
- `lineAmount()` : Money (unitPrice.multiply(quantity))

---

## 4.4 ShippingInfo (Value Object)

### 정의
- 배송지/수령인 정보. 주문 확정 전까지(=CREATED)만 변경 가능(v1에서는 변경 기능 미제공).

### 속성(예시)
- `receiverName` : String
- `phone` : String
- `zipCode` : String
- `address1` : String
- `address2` : String? (nullable)
- `requestMessage` : String? (nullable)

### 규칙(권장)
- 필수 필드는 null/blank 금지
- 길이 제한(예: receiverName 50, phone 20, address 200 등)
- 입력 정규화(trim) 적용

---

## 5. 유스케이스(v1)와 도메인 규칙 매핑

### UC-01 주문 생성(Create Order)
- 입력: buyerId, orderLines(productId, quantity), shippingInfo
- 도메인:
    - Order.create(...)로 생성
    - totalAmount 계산 및 불변식 검증
- 비고:
    - 상품명/단가 스냅샷은 Application에서 product-service 조회 후 채운다.

### UC-02 주문 확정(Confirm Order)
- 도메인: Order.confirm()
- 규칙: CREATED에서만 가능

### UC-03 주문 취소(Cancel Order)
- 도메인: Order.cancel(reason?)
- 규칙: CREATED에서만 가능

---

## 6. JPA 매핑 전략(v1 권장)

- Order: `@Entity`
- Money / OrderLine / ShippingInfo: `@Embeddable` (VO)
- Order.orderLines: `@ElementCollection` + `@CollectionTable(order_lines)`
    - OrderLine은 Order 생명주기에 종속되며, 독립 식별자가 필요 없으므로 컬렉션 테이블이 적합

> 엔티티는 record 사용 금지.  
> VO는 record 사용 가능(Embeddable record 지원 활용).

---

## 7. equals/hashCode 정책(취업용 표준)

- **Value Object(Money, OrderLine, ShippingInfo)**
    - 값 기반 동등성(필드가 같으면 같은 값)
    - record 사용 시 자동 equals/hashCode 활용 가능
- **Entity(Order)**
    - 식별자(id) 기반 동등성
    - 영속화 전(id=null)에는 컬렉션(Set/Map) 키로 사용하지 않는다.

---

## 8. 확장 포인트(v2)

- `CONFIRMED → CANCELLED` 허용(출고 전 취소 정책)
- 배송 상태 연동: `SHIPPING`, `DELIVERED` 등 상태 확장
- 멱등성 키(Idempotency-Key) 기반 중복 주문 방지
- Outbox + Kafka 이벤트 발행(Confirmed/Cancelled 이벤트)

---
